<!DOCTYPE html>












  


  


<html class="theme-next pisces use-motion han-js-rendered no-han-space" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">






  <!--  -->
  
  
  <link rel="stylesheet" href="https://ethantw.github.io/Han/latest/han.min.css">



  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">














  
  
  
  

  

  

  

  

  

  







<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.0">



  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico?v=7.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico?v=7.1.0">








<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="前言  ns-3 is a discrete-event network simulator for Internet systems, targeted primarily for research and educational use. ns-3 is free software, licensed under the GNU GPLv2 license, and is publicly a">
<meta property="og:type" content="website">
<meta property="og:title" content="ns3中的wave模块">
<meta property="og:url" content="http://www.codewoody.com/knowledge-base/academic/its/wave/ns3中的wave模块/index.html">
<meta property="og:site_name" content="治部少辅">
<meta property="og:description" content="前言  ns-3 is a discrete-event network simulator for Internet systems, targeted primarily for research and educational use. ns-3 is free software, licensed under the GNU GPLv2 license, and is publicly a">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2020-01-15T08:07:20.713Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ns3中的wave模块">
<meta name="twitter:description" content="前言  ns-3 is a discrete-event network simulator for Internet systems, targeted primarily for research and educational use. ns-3 is free software, licensed under the GNU GPLv2 license, and is publicly a">



  <link rel="alternate" href="/atom.xml" title="治部少辅" type="application/atom+xml">



  
  
  <link rel="canonical" href="http://www.codewoody.com/knowledge-base/academic/its/wave/ns3中的wave模块/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ns3中的wave模块 | 治部少辅</title>
  




  <script async src="//www.googletagmanager.com/gtag/js?id=UA-114736006-1"></script>
  <script>
    var host = window.location.hostname;
    if (host !== "localhost" || !true) {
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-114736006-1');
    }
  </script>









  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">治部少辅</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">大一大万大吉</h1>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-knowledge menu-item-active">

    
    
    
      
    

    

    <a href="/knowledge-base" rel="section"><i class="menu-item-icon fa fa-fw fa-book"></i> <br>knowledge</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-weekly">

    
    
    
      
    

    

    <a href="/categories/Weekly/" rel="section"><i class="menu-item-icon fa fa-fw fa-newspaper-o"></i> <br>weekly</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-updates">

    
    
    
      
    

    

    <a href="/update" rel="section"><i class="menu-item-icon fa fa-fw fa-edit"></i> <br>updates</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-channel">

    
    
    
      
    

    

    <a href="https://t.me/everthingaboutbullshit" rel="noopener" target="_blank"><i class="menu-item-icon fa fa-fw fa-signal"></i> <br>channel</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    
  
  

  

  <a href="https://github.com/huangy10" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

    
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
    

  


          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    
    
    
    <div class="post-block page">
      <header class="post-header">

<h2 class="post-title" itemprop="name headline">ns3中的wave模块

</h2>

<div class="post-meta">
  
  


  
  
  <ul class="breadcrumb">
    
      
      
        
          
            
          
          
            <li><a href="/knowledge-base/">KNOWLEDGE-BASE</a></li>
          
        
      
    
      
      
        
          
            
          
          
            <li><a href="/knowledge-base/academic/">ACADEMIC</a></li>
          
        
      
    
      
      
        
          
            
          
          
            <li><a href="/knowledge-base/academic/its/">ITS</a></li>
          
        
      
    
      
      
        
          
            
          
          
            <li><a href="/knowledge-base/academic/its/wave/">WAVE</a></li>
          
        
      
    
      
      
        
          <li>NS3中的WAVE模块</li>
        
      
    
      
      
    
  </ul>


</div>

</header>

      
      
      
      <div class="post-body han-init-context">
        
        
          <h2 id="前言">前言</h2>
<blockquote>
<p>ns-3 is a discrete-event network simulator for Internet systems, targeted primarily for research and educational use. ns-3 is free software, licensed under the GNU GPLv2 license, and is publicly available for research, development, and use.</p>
</blockquote>
<p>简而言之，<a href="https://www.nsnam.org/" target="_blank" rel="noopener">ns3</a>是一款基于C++的离散事件网络模拟器，其内部实现了很多常见的网络协议。因此学术界通常使用ns3来作为论文仿真分析的框架。我们在这篇文章里梳理一下ns3中关于WAVE部分的内容。</p>
<h2 id="wave的初始化">WAVE的初始化</h2>
<p>下面的代码给出了一种WAVE机制的初始化方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * lossModelName: 信道损失模型，默认值是</span></span><br><span class="line"><span class="comment"> * ns3::LogDistancePropagationLossModel</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">auto</span> lossModelName = m_config-&gt;Get (<span class="string">"lossModel"</span>);</span><br><span class="line"><span class="keyword">double</span> freq = <span class="number">5e9</span>;</span><br><span class="line">YansWifiChannelHelper waveChannel;</span><br><span class="line">waveChannel.SetPropagationDelay (<span class="string">"ns3::ConstantSpeedPropagationDelayModel"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (lossModelName == <span class="string">"ns3::TwoRayGroundPropagationLossModel"</span>) &#123;</span><br><span class="line">  waveChannel.AddPropagationLoss (lossModelName, <span class="string">"Frequency"</span>, DoubleValue (freq), <span class="string">"HeightAboveZ"</span>, DoubleValue (<span class="number">1.5</span>));</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (lossModelName == <span class="string">"ns3::LogDistancePropagationLossModel"</span>) &#123;</span><br><span class="line">  waveChannel.AddPropagationLoss (lossModelName);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  waveChannel.AddPropagationLoss (lossModelName, <span class="string">"Frequency"</span>, DoubleValue (freq));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * propagationLossModel: 默认是None</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">auto</span> propagationLossModel = m_config-&gt;Get (<span class="string">"propagationLossModel"</span>);</span><br><span class="line"><span class="keyword">if</span> (propagationLossModel != <span class="string">"None"</span>) &#123;</span><br><span class="line">  waveChannel.AddPropagationLoss (propagationLossModel);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create the channel using settings above</span></span><br><span class="line"><span class="keyword">auto</span> wavePhy = YansWavePhyHelper::Default ();</span><br><span class="line">wavePhy.SetChannel (waveChannel.Create ());</span><br><span class="line">wavePhy.SetPcapDataLinkType (WifiPhyHelper::DLT_IEEE802_11);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 发射功率，单位为dbm</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">auto</span> txp = m_config-&gt;Get&lt;<span class="keyword">double</span>&gt; (<span class="string">"txp"</span>);</span><br><span class="line">wavePhy.Set (<span class="string">"TxPowerStart"</span>,DoubleValue (txp));</span><br><span class="line">wavePhy.Set (<span class="string">"TxPowerEnd"</span>, DoubleValue (txp));</span><br><span class="line"></span><br><span class="line">QosWaveMacHelper waveMac = QosWaveMacHelper::Default ();</span><br><span class="line">WaveHelper waveHelper = WaveHelper::Default ();</span><br><span class="line"><span class="keyword">auto</span> phyMode = m_config-&gt;Get (<span class="string">"phyMode"</span>);</span><br><span class="line">waveHelper.SetRemoteStationManager (<span class="string">"ns3::ConstantRateWifiManager"</span>,</span><br><span class="line">                                    <span class="string">"DataMode"</span>,StringValue (phyMode),</span><br><span class="line">                                    <span class="string">"ControlMode"</span>,StringValue (phyMode));</span><br><span class="line">m_devices = waveHelper.Install (wavePhy, waveMac, m_nodes);</span><br></pre></td></tr></table></figure>
<p>这段代码中我们逐一创建了信道模型，物理层，链路层，最后通过<code>waveHelper</code>将各个部分组装在一起，并且安装到节点上：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">m_devices = waveHelper.Install (wavePhy, waveMac, m_nodes);</span><br></pre></td></tr></table></figure>
<h3 id="wavehelper">waveHelper</h3>
<p><code>waveHelper-&gt;Install</code>的核心代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Ptr&lt;Node&gt; node = *i;</span><br><span class="line">Ptr&lt;WaveNetDevice&gt; device = CreateObject&lt;WaveNetDevice&gt; ();</span><br><span class="line"></span><br><span class="line">device-&gt;SetChannelManager (CreateObject&lt;ChannelManager&gt; ());</span><br><span class="line">device-&gt;SetChannelCoordinator (CreateObject&lt;ChannelCoordinator&gt; ());</span><br><span class="line">device-&gt;SetVsaManager (CreateObject&lt;VsaManager&gt; ());</span><br><span class="line">device-&gt;SetChannelScheduler (m_channelScheduler.Create&lt;ChannelScheduler&gt; ());</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">uint32_t</span> j = <span class="number">0</span>; j != m_physNumber; ++j)</span><br><span class="line">  &#123;</span><br><span class="line">    Ptr&lt;WifiPhy&gt; phy = phyHelper.Create (node, device);</span><br><span class="line">    phy-&gt;ConfigureStandard (WIFI_PHY_STANDARD_80211_10MHZ);</span><br><span class="line">    phy-&gt;SetChannelNumber (ChannelManager::GetCch ());</span><br><span class="line">    device-&gt;AddPhy (phy);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">uint32_t</span>&gt;::const_iterator k = m_macsForChannelNumber.begin ();</span><br><span class="line">      k != m_macsForChannelNumber.end (); ++k)</span><br><span class="line">  &#123;</span><br><span class="line">    Ptr&lt;WifiMac&gt; wifiMac = macHelper.Create ();</span><br><span class="line">    Ptr&lt;OcbWifiMac&gt; ocbMac = DynamicCast&lt;OcbWifiMac&gt; (wifiMac);</span><br><span class="line">    <span class="comment">// we use WaveMacLow to replace original MacLow</span></span><br><span class="line">    ocbMac-&gt;EnableForWave (device);</span><br><span class="line">    ocbMac-&gt;SetWifiRemoteStationManager ( m_stationManager.Create&lt;WifiRemoteStationManager&gt; ());</span><br><span class="line">    ocbMac-&gt;ConfigureStandard (WIFI_PHY_STANDARD_80211_10MHZ);</span><br><span class="line">    device-&gt;AddMac (*k, ocbMac);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">device-&gt;SetAddress (Mac48Address::Allocate ());</span><br><span class="line"></span><br><span class="line">node-&gt;AddDevice (device);</span><br><span class="line">devices.Add (device);</span><br></pre></td></tr></table></figure>
<p>首先创建WAVE设备，并且设置<code>ChannelCoordinator</code>, <code>VsaManager</code>, <code>ChannelScheduler</code>，逐一最后一个是通过是通过工厂对象创建的。工厂对象默认创建的<code>ChannelScheduler</code>是<code>ns3::DefaultChannelScheduler</code>(事实上ns3内部只有这一个具体的<code>ChannelCoordinator</code>实现).</p>
<p>在接下来的循环中，<code>waveHelper</code>利用参数中传入的物理层<code>Helper</code>来创建物理层对象。这里的<code>m_physNumber</code>默认为1。对于物理层，这里进一步设置了信道带宽标准（10MHz），将信道号设置为CCH信道号。</p>
<p>在第二个循环中，<code>waveHelpher</code>创建WAVE的七个信道，这里的<code>m_macsForChannelNumber</code>默认来自<code>ChannelManager::GetWaveChannels ()</code>。在循环体内，对于每一个WAVE信道，<code>wave</code>进行如下操作：</p>
<ol type="1">
<li>启用WAVE支持(这一部分详细阅读以下面的<code>waveMac</code>章节)</li>
<li>设置RemoteStationManager</li>
<li>设置标准为<code>WIFI_PHY_STANDARD_80211_10MHZ</code></li>
</ol>
<p>最后为设备分配MAC地址。</p>
<h3 id="wavephy">wavePhy</h3>
<p><code>YansWavePhyHelper</code>继承了<code>YansWifiPhyHelper</code>。相比于父类，<code>wavePhy</code>其实主要修改了自带的日志输出范式，对于功能主干影响不大。我们来看关键的<code>YansWifiPhyHelper::Create</code>函数。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Ptr&lt;WifiPhy&gt;</span><br><span class="line">YansWifiPhyHelper::Create (Ptr&lt;Node&gt; node, Ptr&lt;NetDevice&gt; device) <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line">  Ptr&lt;YansWifiPhy&gt; phy = m_phy.Create&lt;YansWifiPhy&gt; ();</span><br><span class="line">  Ptr&lt;ErrorRateModel&gt; error = m_errorRateModel.Create&lt;ErrorRateModel&gt; ();</span><br><span class="line">  phy-&gt;SetErrorRateModel (error);</span><br><span class="line">  phy-&gt;SetChannel (m_channel);</span><br><span class="line">  phy-&gt;SetDevice (device);</span><br><span class="line">  <span class="keyword">return</span> phy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数只是按部就班地设置对应的属性，没有特别的处理。</p>
<h3 id="wavemac">waveMac</h3>
<p><code>waveMac</code>直接使用了<code>QosWaveMacHelper</code>的默认设置。这个部分Helper配置的部分极少。可以认为是直接从构造函数创建<code>OcbWifiMac</code>。</p>
<blockquote>
<p>OCB，即Outside Context of BSS，即脱离BSS的组织形式，让节点直接直接进行通信的范式。 <code>OcbWifiMac</code> 的注释可以提供进一步的说明：</p>
<p>In OCB mac mode,synchronization, association, dis-association and authentication of normal wifi are not used for wireless access in vehicular environments.</p>
<p>Although Timing Advertisement frame is a specific management frame defined in 802.11p. It is mainly used by IEEE Std 1609.4 for channel switch synchronization. However in simulation nodes are supposed to have GPS synchronization ability, so we will not implement this feature.</p>
</blockquote>
<p>关于<code>OcbWifiMac::EnableForWave</code>的说明：</p>
<p>在<code>waveHelper</code>的处理中，对创建的<code>OcbWifiMac</code>对象调用了<code>EnableForMac</code>函数。这个函数的主要作用是，将<code>OcbWifiMac</code>的<code>m)low</code>底层MAC实现，从<code>MacLow</code>替换为<code>WaveMacLow</code>。</p>
<h2 id="wave中的tx">WAVE中的Tx</h2>
<h3 id="通过wavenetdevice直接发包方式下的路径">通过WaveNetDevice直接发包方式下的路径</h3>
<p>这里我们使用直接从<code>WaveNetDevice</code>的发送接口进行发包的方法。例如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> sender = DynamicCast&lt;WaveNetDevice&gt; (m_devices.Get (<span class="number">0</span>));</span><br><span class="line"><span class="keyword">auto</span> receiver = DynamicCast&lt;WaveNetDevice&gt; (m_devices.Get (<span class="number">1</span>));</span><br><span class="line"><span class="keyword">const</span> Address dest = receiver-&gt;GetAddress ();</span><br><span class="line">SeqTsHeader seqTs;</span><br><span class="line">seqTs.SetSeq (<span class="number">1</span>);</span><br><span class="line">packet-&gt;AddHeader (seqTs);</span><br><span class="line"><span class="comment">// 0x0800是IP协议号</span></span><br><span class="line">sender-&gt;Send (packet, dest, <span class="number">0x0800</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里的协议号是<code>0x0800</code>，即发送的是IP包，IP包只能在CCH上发送</p>
</blockquote>
<p>注意在执行上面的发送前还需要对WAVE进行信道配置，否则无法发送。信道配置不需要在每次发送前配置，只需要在设置发生变更的时候修改设置即可。配置的示例代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> schInfo = SchInfo (SCH1, immediateAccess, EXTENDED_ALTERNATING);</span><br><span class="line"><span class="keyword">auto</span> txProfile = TxProfile (SCH1);</span><br><span class="line"><span class="keyword">auto</span> sender = DynamicCast&lt;WaveNetDevice&gt; (m_devices.Get (<span class="number">0</span>));</span><br><span class="line"><span class="keyword">auto</span> receiver = DynamicCast&lt;WaveNetDevice&gt; (m_devices.Get (<span class="number">1</span>));</span><br><span class="line">Simulator::Schedule (</span><br><span class="line">  Seconds (<span class="number">0</span>), &amp;WaveNetDevice::RegisterTxProfile, sender, txProfile);</span><br><span class="line">Simulator::Schedule (</span><br><span class="line">  Seconds (<span class="number">0</span>), &amp;WaveNetDevice::RegisterTxProfile, receiver, txProfile);</span><br><span class="line">Simulator::Schedule (</span><br><span class="line">  Seconds (<span class="number">0</span>), &amp;WaveNetDevice::StartSch, sender, schInfo);</span><br><span class="line">Simulator::Schedule (</span><br><span class="line">  Seconds (<span class="number">0</span>), &amp;WaveNetDevice::StartSch, receiver, schInfo);</span><br></pre></td></tr></table></figure>
<h4 id="wavenetdevicesend">WaveNetDevice::Send</h4>
<p>这里的调用入口是<code>WaveNetDevice::Send(ns3::Ptr&lt;...&gt; packet, const ns3::Address &amp;dest, uint16_t protocol)</code>. 这个函数中做了如下处理:</p>
<ol type="1">
<li>检查<code>m_txProfile</code>，在WAVE中的，要发送数据必须要先注册一个<code>TxProfile</code>，这个结构提供了上层对于物理底层参数的控制能力。</li>
<li>检查还是否可以访问<code>m_txProfile</code>中指定的信道。</li>
<li>检查<code>m_txProfile</code>中的其他参数，并生成一个<code>HigherLayerTxVectorTag</code>的PacketTag添加到包中。</li>
<li>添加<code>LlcSnapHeader</code>，此Header中包含了协议类型（如是IP包，协议为<code>0x0800</code>）。</li>
<li>根据<code>m_txProfile</code>中制定的信道编号，获取对应的<code>WifiMac</code>(实质是<code>OcbWifiMac</code>)，将包压入其队列。这一级调用见下一个子部分。</li>
</ol>
<h4 id="ocbwifimacenqueue">OcbWifiMac::Enqueue</h4>
<p>这个函数里的处理主要分为两个部分：一是<code>m_stationManager</code>的相关处理，二是QoS相关的处理。同时，MAC帧头<code>WifiMacHeader</code>也在这里生成。</p>
<p>注意，在WAVE中，QoS功能是启用的，即<code>GetQosSupported</code>返回<code>true</code>。那么发送队列的选择会由<a href="https://en.wikipedia.org/wiki/IEEE_802.11e-2005#Enhanced_distributed_channel_access_.28EDCA.29" target="_blank" rel="noopener">EDCA</a>机制来控制:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">m_edca[QosUtilsMapTidToAc (tid)]-&gt;Queue (packet, hdr);</span><br></pre></td></tr></table></figure>
<p>其中<code>m_edca</code>的类型为<code>EdcaQeueus</code>（<code>typedef std::map&lt;AcIndex, Ptr&lt;QosTxop&gt; &gt; EdcaQueues;</code>），本质从EDCA的Access Category index映射到对应对应队列的字典。</p>
<h4 id="qostxopqueue">QosTxop::Queue</h4>
<p><code>QosTxOp</code>继承自<code>Txop</code>。<code>Queue</code>这个函数没有改动。在<code>Txop::Queue</code>内，传入的包被纳入<code>m_queue</code>这个内部队列，然后<code>StartAccessIfNeeded</code>被调用来尝试访问信道。</p>
<blockquote>
<p><code>m_queue</code>是<code>WifiMacQueue</code>类型。这个队列实现了802.11协议中的超时功能。在包被取出时，队列检查其时间戳，如果超时会丢弃这个包。</p>
</blockquote>
<h4 id="channelaccessmanagerstartaccessifneeded">ChannelAccessManager::StartAccessIfNeeded</h4>
<p><code>StartAccessIfNeeded</code>是开始信道访问尝试的入口，这个过程涉及众多函数，我们在这里统一梳理。</p>
<p>在<code>StartAccessIfNeeded</code>函数中，若</p>
<ol type="1">
<li><code>m_currentPacket</code>为空，即当前没有正在发送的包。</li>
<li><code>m_queue</code>不是空，即还有包等待发送</li>
<li><code>IsAccessRequested()</code>为<code>false</code>，为了避免请求信道重复</li>
<li><code>m_low-&gt;IsCfPeriod</code>为<code>false</code>，底层mac是否处于可供发送的状态 (CF: Contention-Free)</li>
</ol>
<p>以上条件全部得到满足，那么<code>Txop</code>会通过<code>m_channelAccessManager-&gt;RequestAccess</code>来请求访问信道。</p>
<blockquote>
<p>这里的<code>m_channelAccessManager</code>是从<code>RegularWifiMac::m_channelAccessManager</code>赋值而来，不同的同一个mac层的不同<code>Txop</code>共享。</p>
</blockquote>
<p><code>ChannelAccessManager</code>会处理和退避相关的事宜：</p>
<ol type="1">
<li>如果信道可以访问，调用<code>ChannelAccessManager::DoGrantAccess</code></li>
<li>不管在任何情况下，调用<code>ChannelAccessManager::DoRestartAccessTimeoutIfNeeded</code>，这一步是为了调度一下次对信道的访问尝试（例如如果本次访问信道失败，则重新更新退避信息后，在一定间隔后再次访问信道）。</li>
</ol>
<p>在<code>DoGrantAccess</code>中，最终成功访问到信道的<code>Txop</code>的<code>NotifyAccessGranted</code>函数会被调用。</p>
<p>信道的访问规则使我们关注的重点，尤其是CCH和SCH的信道访问控制。经过测试发现，在CCHI时请求SCH信道时，不会调用<code>DoGrantAccess</code>。在CCHI发起SCH请求时，<code>m_sleeping</code>为true，因此会在<code>RequestAccess</code>函数开头即返回，这里也不会通过<code>DoRestartAccessTimeoutIfNeeded</code>来调度下一次信道访问（毕竟信道睡眠中）。可见WAVE的Aternative Accessing在MAC层是通过让<code>OcbWaveMac</code>周期性地睡眠实现的。这一功能主要实现于<code>DefaultChannelScheduler</code>中。</p>
<h4 id="qostxopnotifyaccessgranted"><code>QosTxop::NotifyAccessGranted</code></h4>
<p><code>QosTxop</code>覆盖了<code>NotifyAccessGranted</code>的实现。在这函数里面，<code>WifiMacHeader</code>中的一些参数进行了重新设置。主要包括：</p>
<ol type="1">
<li>SeqNo</li>
<li>禁止分段（即将大包拆解成小包传输）</li>
<li>NoRetry</li>
</ol>
<p>注意，对于QoS数据包，ACK在这里被禁用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (m_currentHdr.IsQosData () &amp;&amp; m_currentHdr.IsQosBlockAck ())</span><br><span class="line">&#123;</span><br><span class="line">  m_currentParams.DisableAck ();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  m_currentParams.EnableAck ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在涉及参数配置以及<code>AMSDU</code>等方面的设置完成后调用<code>m_low-&gt;StartTransmission</code>。前面我们提到过，这里的<code>m_low</code>为<code>WaveMacLow</code>类型。</p>
<h4 id="wavemaclowstarttransmission"><code>WaveMacLow::StartTransmission</code></h4>
<h4 id="发送过程中地址的处理">发送过程中地址的处理</h4>
<p><code>WaveNetDevice::Send</code>接口发送数据时，我们发现发送的目标地址并不是设置到packet里面，而是独立传递进了接口。这里简要梳理一下在发送过程中地址的处理。</p>
<p>在<code>WaveNetDevice::Send</code>函数中，<code>Address</code>类型的目标地址被转换成<code>Mac48Address</code>类型，再传递给<code>OcbWifiMac::Enqueue</code>函数。在这个函数里面，这个地址被复制给802.11的帧头的<code>addr1</code>字段。帧头的类型为<code>WifiMacHeader</code></p>
<h3 id="rtscts">RTS/CTS</h3>
<p>RTS/CTS部分是由<code>MacLow</code>负责的，我们从<code>MacLow::StartTransmission</code>开始梳理。</p>
<h4 id="needrts">NeedRTS</h4>
<p>首先要讨论的是，系统如何决定一个包是否需要进行RTS</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span></span><br><span class="line">MacLow::NeedRts (<span class="keyword">void</span>) <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line">  WifiTxVector dataTxVector = GetDataTxVector (m_currentPacket, &amp;m_currentHdr);</span><br><span class="line">  <span class="keyword">return</span> m_stationManager-&gt;NeedRts (m_currentHdr.GetAddr1 (), &amp;m_currentHdr, m_currentPacket, dataTxVector);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的取出来的<code>dataTxVector</code>的作用并不关键，其主要作用的是两个因素：</p>
<ol type="1">
<li>地址是否是group: <code>address.IsGroup ()</code></li>
<li>包的大小是否超过了<code>WifiRemoteStationManager::m_rtsCtsThreshold</code>。不过这个包被默认设置为65535，这个条件几乎无法满足.</li>
</ol>
<h3 id="wsa包的发送">WSA包的发送</h3>
<p>发送WSA包时，配置方法与发送IP包的是一致的，具体到发送上，餐卡<code>wave-simple-device.cc</code>里面的示例:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Ptr&lt;Packet&gt; wsaPacket = Create&lt;Packet&gt; (<span class="number">100</span>);</span><br><span class="line">Mac48Address dest = Mac48Address::GetBroadcast ();</span><br><span class="line"><span class="keyword">const</span> VsaInfo vsaInfo = VsaInfo (dest, OrganizationIdentifier (), <span class="number">0</span>, wsaPacket, SCH1, <span class="number">100</span>, VSA_TRANSMIT_IN_BOTHI);</span><br><span class="line">Simulator::Schedule (Seconds (<span class="number">1.0</span>), &amp;WaveNetDevice::StartVsa, sender, vsaInfo);</span><br><span class="line">Simulator::Schedule (Seconds (<span class="number">3.0</span>), &amp;WaveNetDevice::StopVsa, sender, SCH1);</span><br></pre></td></tr></table></figure>
<h4 id="vsainfo">VsaInfo</h4>
<p><code>VsaInfo</code>的定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">struct VsaInfo</span><br><span class="line">&#123;</span><br><span class="line">  Mac48Address peer; ///&lt; peer</span><br><span class="line">  OrganizationIdentifier oi; ///&lt; OI</span><br><span class="line">  uint8_t managementId; ///&lt; management ID</span><br><span class="line">  Ptr&lt;Packet&gt; vsc; ///&lt; VSC</span><br><span class="line">  uint32_t channelNumber; ///&lt; channel number</span><br><span class="line">  uint8_t repeatRate; ///&lt; repeat rate</span><br><span class="line">  enum VsaTransmitInterval sendInterval; ///&lt; send interval</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中：</p>
<ol type="1">
<li><code>peer</code>: 为发送目标地址，一般是广播地址</li>
<li><code>oi</code>: 服务提供者的组织ID</li>
<li><code>managementId</code>: manage id</li>
<li><code>vsc</code>: 需要发送的包内容</li>
<li><code>channelNumber</code>: 目标信道，这里指需要指定的SCH信道</li>
<li><code>repeatRate</code>: 发送速度，即每秒多少个</li>
<li><code>sendInterval</code>: 这是一个枚举类型，指定了包应该在哪些时隙上发送。其取值包括：
<ol type="1">
<li>VSA_TRANSMIT_IN_CCHI</li>
<li>VSA_TRANSMIT_IN_SCHI</li>
<li>VSA_TRANSMIT_IN_BOTHI</li>
</ol></li>
</ol>
<h4 id="wavenetdevicestartvsa">WaveNetDevice::StartVsa</h4>
<p>传入参数<code>vsaInfo</code>中规定了发送WSA包的必要信息。在<code>WaveNetDevice::StartVsa</code>函数中，设备检查了<code>vsaInfo</code>的数据的完整性，然后交给<code>m_vsaManager-&gt;SendVsa</code>来进行发送。在<code>VsaManager</code>中，CCHI和SCHI的访问控制，以及<code>txVector</code>的控制信息都在这里实现，同时，此包被赋予了EDCA最高优先级(AC_V0)。然后交给<code>OcbWifiMac-&gt;SendVsc</code>来执行发送。通过这个接口发送的包会被标记为管理包。</p>
<h3 id="wave中的信道管理">WAVE中的信道管理</h3>
<p><code>ChannelCoordinator</code>负责控制信道切换的时机，让所有的节点的信道切换同步，而<code>ChannelScheduler</code>负责执行具体的信道切换。在<code>DefaultChannelScheduler::SetWaveNetDevice</code>中，<code>ChannelCoordinator</code>和<code>ChannelScheduler</code>得以联系起来：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">m_coordinationListener = Create&lt;CoordinationListener&gt; (<span class="keyword">this</span>);</span><br><span class="line">m_coordinator-&gt;RegisterListener (m_coordinationListener);</span><br></pre></td></tr></table></figure>
<p><code>ChannelCoordinator</code>在调用其<code>DoInitialize</code>函数内部完成初始化之后即通过<code>StartChannelCoordination</code>函数开启往复调用的信道协调同步过程。这个过程首先进入的是Guard Interval(<code>NotifyGuardSlot</code>)。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ChannelCoordinator::NotifyGuardSlot (<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  NS_LOG_FUNCTION (<span class="keyword">this</span>);</span><br><span class="line">  Time guardSlot = GetGuardInterval ();</span><br><span class="line">  <span class="keyword">bool</span> inCchi = ((m_guardCount % <span class="number">2</span>) == <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (inCchi)</span><br><span class="line">    &#123;</span><br><span class="line">      m_coordination = Simulator::Schedule (guardSlot, &amp;ChannelCoordinator::NotifyCchSlot, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      m_coordination = Simulator::Schedule (guardSlot, &amp;ChannelCoordinator::NotifySchSlot, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">for</span> (ListenersI i = m_listeners.begin (); i != m_listeners.end (); ++i)</span><br><span class="line">    &#123;</span><br><span class="line">      (*i)-&gt;NotifyGuardSlotStart (guardSlot, inCchi);</span><br><span class="line">    &#125;</span><br><span class="line">  m_guardCount++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个函数里面根据<code>inCchi</code>来决定调度<code>NotifyCchSlot</code>还是<code>NotifiySchSlot</code>。在函数最末，通告所有的Listener，Guard Interval开始了。后续的<code>NotifyCchSlot</code>和<code>NotifiySchSlot</code>的做法也是类似的。</p>
<p>在<code>DefaultChannelScheduler::NotifyGuardSlotStart</code>中，开头的Guard Interval长度被设置为繁忙<code>mac-&gt;MakeVirtualBusy (duration);</code>。实际的信道切换过程也在这个函数中通过调用<code>DefaultChannelScheduler::SwitchToNextChannel</code>来进行。由于Guard Interval区间内被设置为繁忙，所以当设备结束睡眠时，检测信道繁忙，故而会开始执行退避。</p>
<blockquote>
<p>这里有一个疑问：<code>ChannelCoordinator</code>内部的Schedule调度完全是独立进行的，如果采用了Extended Access，即CCHI会提前结束，那么原定的Guard Interval还是会被设置么？</p>
</blockquote>
<h3 id="退避过程backoff">退避过程(Backoff)</h3>
<p>退避过程主要实现在<code>ChannelAccessManager</code>内。在<code>Txop::Queue</code>函数收到一个包之后，会调用<code>Txop::StartAccessIfNeeded</code>这个函数来尝试访问信道。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">Txop::StartAccessIfNeeded (<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  NS_LOG_FUNCTION (<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">if</span> (m_currentPacket == <span class="number">0</span></span><br><span class="line">      &amp;&amp; !m_queue-&gt;IsEmpty ()</span><br><span class="line">      &amp;&amp; !IsAccessRequested ()</span><br><span class="line">      &amp;&amp; !m_low-&gt;IsCfPeriod ())</span><br><span class="line">    &#123;</span><br><span class="line">      m_channelAccessManager-&gt;RequestAccess (<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实质调用的<code>ChannelAccessManager::RequestAccess</code>这个函数。这个函数我们挑选其中重要的代码列在下面：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ChannelAccessManager::RequestAccess (Ptr&lt;Txop&gt; state, <span class="keyword">bool</span> isCfPeriod)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  UpdateBackoff ();</span><br><span class="line">  NS_ASSERT (!state-&gt;IsAccessRequested ());</span><br><span class="line">  state-&gt;NotifyAccessRequested ();</span><br><span class="line">  Time lastTxEnd = m_lastTxStart + m_lastTxDuration;</span><br><span class="line">  <span class="keyword">if</span> (lastTxEnd &gt; Simulator::Now ())</span><br><span class="line">    &#123;</span><br><span class="line">      NS_LOG_DEBUG (<span class="string">"Internal collision (currently transmitting)"</span>);</span><br><span class="line">      state-&gt;NotifyInternalCollision ();</span><br><span class="line">      DoRestartAccessTimeoutIfNeeded ();</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (state-&gt;GetBackoffSlots () == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (IsBusy ())</span><br><span class="line">        &#123;</span><br><span class="line">          NS_LOG_DEBUG (<span class="string">"medium is busy: collision"</span>);</span><br><span class="line">          <span class="comment">// someone else has accessed the medium; generate a backoff.</span></span><br><span class="line">          state-&gt;NotifyCollision ();</span><br><span class="line">          DoRestartAccessTimeoutIfNeeded ();</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (IsWithinAifs (state))</span><br><span class="line">        &#123;</span><br><span class="line">          NS_LOG_DEBUG (<span class="string">"busy within AIFS"</span>);</span><br><span class="line">          state-&gt;NotifyCollision ();</span><br><span class="line">          DoRestartAccessTimeoutIfNeeded ();</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  DoGrantAccess ();</span><br><span class="line">  DoRestartAccessTimeoutIfNeeded ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数内部主要步骤为：</p>
<ol type="1">
<li>检查是否有内部冲突，即当前是否正在发送一个数据包。如果发生了内部冲突，会调用<code>Txop::NotifyInternalCollision</code>回调，并通过<code>DoRestartAccessTimeoutIfNeeded</code>这个函数在一段时间后重新访问信道。</li>
<li>检查退避计数器的状态：如果计数器到0了，若信道繁忙，则认为产生了一次碰撞，若仍然在Aifs状态，那么也认为是一次碰撞（事实上这里的两个分支是一样的）</li>
<li>如果退避计数器不是0，即上一次退避未完成时，通过<code>DoRestartAccessTimeoutIfNeeded</code>这个函数延后访问信道（这里的<code>DoGrantAccess</code>函数不会允许访问信道）。</li>
</ol>
<p>下面我们分解讲一下主要函数的作用。</p>
<h4 id="updatebackoff"><code>UpdateBackoff</code></h4>
<p>在实际的WAVE系统中，其退避过程为了性能考虑采用是离散的方法，即定一个退避计数器，每经过一个时隙（slot），这个退避计数器减一，直到变成0。有意思的是，在仿真系统中，NS3反而是使用了“连续”的方法来实现（当然本质是离散的，但是API调用形式上使用<code>Simulator::Schedule</code>直接调度backoff相关事件，显得是连续的）。此时，我们如果要访问退避计数器的值，如调用（<code>state-&gt;GetBackoffSlots ()</code>），就需要先调用<code>UpdateBackoff</code>这个函数来进行离散和连续的转化。</p>
<h4 id="dorestartaccesstimeoutifneeded"><code>DoRestartAccessTimeoutIfNeeded</code></h4>
<p>在<code>ChannelAccessManager</code>的实现中，<code>ChannelAccessManager</code>和<code>Txop</code>是一对多的关系，即多个<code>Txop</code>可以由同一个<code>ChannelAccessManager</code>来管理。不过在实际代码中，至少我们关注的<code>RegularWifiMac</code>及其子类，<code>ChannelAccessManager</code>和<code>Txop</code>都是一对一。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">RegularWifiMac::RegularWifiMac ()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  m_channelAccessManager = CreateObject&lt;ChannelAccessManager&gt; ();</span><br><span class="line">  m_channelAccessManager-&gt;SetupLow (m_low);</span><br><span class="line"></span><br><span class="line">  m_txop = CreateObject&lt;Txop&gt; ();</span><br><span class="line">  m_txop-&gt;SetMacLow (m_low);</span><br><span class="line">  m_txop-&gt;SetChannelAccessManager (m_channelAccessManager);</span><br><span class="line">  m_txop-&gt;SetTxMiddle (m_txMiddle);</span><br><span class="line">  m_txop-&gt;SetTxOkCallback (MakeCallback (&amp;RegularWifiMac::TxOk, <span class="keyword">this</span>));</span><br><span class="line">  m_txop-&gt;SetTxFailedCallback (MakeCallback (&amp;RegularWifiMac::TxFailed, <span class="keyword">this</span>));</span><br><span class="line">  m_txop-&gt;SetTxDroppedCallback (MakeCallback (&amp;RegularWifiMac::NotifyTxDrop, <span class="keyword">this</span>));</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们这里还是假定以存在多个<code>txop</code>的情况来讨论。在<code>DoRestartAccessTimeoutIfNeeded</code>中，函数首先根据当前的状态，选择出最近一个结束一轮退避过程<code>Txop</code>的退避结束时间<code>expectedBackoffEnd</code>。如果当前已经安排的<code>m_accessTimeout</code>时间在这个退避结束时间后面，那么以新的时间重新调调度一个<code>m_accessTimeout</code>事件。这一事件的回调函数是<code>ChannelAccessManager::AccessTimeout</code></p>
<h4 id="accesstimeout"><code>AccessTimeout</code></h4>
<p>这个函数内部非常简单：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ChannelAccessManager::AccessTimeout (<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  NS_LOG_FUNCTION (<span class="keyword">this</span>);</span><br><span class="line">  UpdateBackoff ();</span><br><span class="line">  DoGrantAccess ();</span><br><span class="line">  DoRestartAccessTimeoutIfNeeded ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="dograntaccess"><code>DoGrantAccess</code></h4>
<p>这个函数内部进行真正的信道权限赋予的操作。不过函数仍然会检查每个<code>Txop</code>的退避状态，只有完成了退避的<code>Txop</code>才有可能被赋予信道访问权限。另外，对于 其他正在尝试访问信道的<code>Txop</code>，会出发一次Internal Collision.</p>
<p>被赋予信道访问权限的<code>Txop</code>的<code>NotifyAccessGranted</code>函数会被调用.</p>
<h3 id="edca优先级控制">EDCA优先级控制</h3>
<h4 id="发送过程优先级设置">发送过程优先级设置</h4>
<p>EDCA优先级控制通过过程如下：</p>
<p>在<code>WaveNetDevice::SendX</code>函数的参数<code>TxInfo</code>中，包含一个<code>priority</code>的属性，这个属性被设置到<code>SocketPriorityTag</code>中，并被添加到包中。在<code>OcbWifiMac::Enqueue</code>函数中通过<code>QosUtilsMapTidToAc</code>函数转化成EDCA index，具体转化规则为：</p>
<ol type="1">
<li>0, 3 -&gt; VC_BE (Best Effort)</li>
<li>1, 2 -&gt; AC_BK (Background)</li>
<li>4, 5 -&gt; VC_VI (Video)</li>
<li>6, 7 -&gt; VC_VO (Audio)</li>
</ol>
<p>这里的Priority的默认值是7</p>
<h4 id="优先级的退避参数设置">优先级的退避参数设置</h4>
<p>WAVE使用的是<code>OcbWifiMac</code>，对EDCA队列的配置通过函数<code>OcbWifiMac::ConfigureEdca</code>来进行。这个函数的调用树如下：</p>
<p><code>WaveHelper::Install</code> -&gt; <code>WifiMac::ConfigureStandard</code> -&gt; <code>OcbWifiMac::FinishConfigureStandard</code> -&gt; <code>OcbWifiMac::ConfigureEdca</code>.</p>
<p><code>OcbWifiMac::ConfigureEdca</code>中的具体设置过程如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">OcbWifiMac::ConfigureEdca (<span class="keyword">uint32_t</span> cwmin, <span class="keyword">uint32_t</span> cwmax, <span class="keyword">uint32_t</span> aifsn, <span class="keyword">enum</span> AcIndex ac)</span><br><span class="line">&#123;</span><br><span class="line">  NS_LOG_FUNCTION (<span class="keyword">this</span> &lt;&lt; cwmin &lt;&lt; cwmax &lt;&lt; aifsn &lt;&lt; ac);</span><br><span class="line">  Ptr&lt;Txop&gt; dcf;</span><br><span class="line">  <span class="keyword">switch</span> (ac)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> AC_VO:</span><br><span class="line">      dcf = RegularWifiMac::GetVOQueue ();</span><br><span class="line">      dcf-&gt;SetMinCw ((cwmin + <span class="number">1</span>) / <span class="number">4</span> - <span class="number">1</span>);</span><br><span class="line">      dcf-&gt;SetMaxCw ((cwmin + <span class="number">1</span>) / <span class="number">2</span> - <span class="number">1</span>);</span><br><span class="line">      dcf-&gt;SetAifsn (aifsn);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> AC_VI:</span><br><span class="line">      dcf = RegularWifiMac::GetVIQueue ();</span><br><span class="line">      dcf-&gt;SetMinCw ((cwmin + <span class="number">1</span>) / <span class="number">2</span> - <span class="number">1</span>);</span><br><span class="line">      dcf-&gt;SetMaxCw (cwmin);</span><br><span class="line">      dcf-&gt;SetAifsn (aifsn);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> AC_BE:</span><br><span class="line">      dcf = RegularWifiMac::GetBEQueue ();</span><br><span class="line">      dcf-&gt;SetMinCw (cwmin);</span><br><span class="line">      dcf-&gt;SetMaxCw (cwmax);</span><br><span class="line">      dcf-&gt;SetAifsn (aifsn);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> AC_BK:</span><br><span class="line">      dcf = RegularWifiMac::GetBKQueue ();</span><br><span class="line">      dcf-&gt;SetMinCw (cwmin);</span><br><span class="line">      dcf-&gt;SetMaxCw (cwmax);</span><br><span class="line">      dcf-&gt;SetAifsn (aifsn);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> AC_BE_NQOS:</span><br><span class="line">      dcf = RegularWifiMac::GetTxop ();</span><br><span class="line">      dcf-&gt;SetMinCw (cwmin);</span><br><span class="line">      dcf-&gt;SetMaxCw (cwmax);</span><br><span class="line">      dcf-&gt;SetAifsn (aifsn);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> AC_UNDEF:</span><br><span class="line">      NS_FATAL_ERROR (<span class="string">"I don't know what to do with this"</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里AIFSN的取值为：</p>
<ul>
<li>AC_BE_NQOS: 2</li>
<li>AC_VO: 2</li>
<li>AC_VI: 3</li>
<li>AC_BE: 6</li>
<li>AC_BK: 9</li>
</ul>

        
      </div>
      
      
      
    </div>
    


  
  
  <ul class="breadcrumb">
    
      
      
        
          
            
          
          
            <li><a href="/knowledge-base/">KNOWLEDGE-BASE</a></li>
          
        
      
    
      
      
        
          
            
          
          
            <li><a href="/knowledge-base/academic/">ACADEMIC</a></li>
          
        
      
    
      
      
        
          
            
          
          
            <li><a href="/knowledge-base/academic/its/">ITS</a></li>
          
        
      
    
      
      
        
          
            
          
          
            <li><a href="/knowledge-base/academic/its/wave/">WAVE</a></li>
          
        
      
    
      
      
        
          <li>NS3中的WAVE模块</li>
        
      
    
      
      
    
  </ul>


    
    
    
  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://imgs.codewoody.com/uploads/big/0330eb8242d9bfc4873c11450f0ab691.jpg" alt="治部少辅">
            
              <p class="site-author-name" itemprop="name">治部少辅</p>
              <div class="site-description motion-element" itemprop="description">晚来天雨雪，能饮一杯无？</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">113</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">14</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">58</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/huangy10" title="GitHub &rarr; https://github.com/huangy10" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://www.zhihu.com/people/woody-huang" title="知乎 &rarr; https://www.zhihu.com/people/woody-huang" rel="noopener" target="_blank"><i class="fa fa-fw fa-zhihu"></i>知乎</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://www.jianshu.com/u/927273827560" title="简书 &rarr; https://www.jianshu.com/u/927273827560" rel="noopener" target="_blank"><i class="fa fa-fw fa-jianshu"></i>简书</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#wave的初始化"><span class="nav-number">2.</span> <span class="nav-text">WAVE的初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#wavehelper"><span class="nav-number">2.1.</span> <span class="nav-text">waveHelper</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#wavephy"><span class="nav-number">2.2.</span> <span class="nav-text">wavePhy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#wavemac"><span class="nav-number">2.3.</span> <span class="nav-text">waveMac</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#wave中的tx"><span class="nav-number">3.</span> <span class="nav-text">WAVE中的Tx</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#通过wavenetdevice直接发包方式下的路径"><span class="nav-number">3.1.</span> <span class="nav-text">通过WaveNetDevice直接发包方式下的路径</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#wavenetdevicesend"><span class="nav-number">3.1.1.</span> <span class="nav-text">WaveNetDevice::Send</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ocbwifimacenqueue"><span class="nav-number">3.1.2.</span> <span class="nav-text">OcbWifiMac::Enqueue</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#qostxopqueue"><span class="nav-number">3.1.3.</span> <span class="nav-text">QosTxop::Queue</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#channelaccessmanagerstartaccessifneeded"><span class="nav-number">3.1.4.</span> <span class="nav-text">ChannelAccessManager::StartAccessIfNeeded</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#qostxopnotifyaccessgranted"><span class="nav-number">3.1.5.</span> <span class="nav-text">QosTxop::NotifyAccessGranted</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#wavemaclowstarttransmission"><span class="nav-number">3.1.6.</span> <span class="nav-text">WaveMacLow::StartTransmission</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#发送过程中地址的处理"><span class="nav-number">3.1.7.</span> <span class="nav-text">发送过程中地址的处理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#rtscts"><span class="nav-number">3.2.</span> <span class="nav-text">RTS/CTS</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#needrts"><span class="nav-number">3.2.1.</span> <span class="nav-text">NeedRTS</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#wsa包的发送"><span class="nav-number">3.3.</span> <span class="nav-text">WSA包的发送</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#vsainfo"><span class="nav-number">3.3.1.</span> <span class="nav-text">VsaInfo</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#wavenetdevicestartvsa"><span class="nav-number">3.3.2.</span> <span class="nav-text">WaveNetDevice::StartVsa</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#wave中的信道管理"><span class="nav-number">3.4.</span> <span class="nav-text">WAVE中的信道管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#退避过程backoff"><span class="nav-number">3.5.</span> <span class="nav-text">退避过程(Backoff)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#updatebackoff"><span class="nav-number">3.5.1.</span> <span class="nav-text">UpdateBackoff</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dorestartaccesstimeoutifneeded"><span class="nav-number">3.5.2.</span> <span class="nav-text">DoRestartAccessTimeoutIfNeeded</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#accesstimeout"><span class="nav-number">3.5.3.</span> <span class="nav-text">AccessTimeout</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dograntaccess"><span class="nav-number">3.5.4.</span> <span class="nav-text">DoGrantAccess</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#edca优先级控制"><span class="nav-number">3.6.</span> <span class="nav-text">EDCA优先级控制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#发送过程优先级设置"><span class="nav-number">3.6.1.</span> <span class="nav-text">发送过程优先级设置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#优先级的退避参数设置"><span class="nav-number">3.6.2.</span> <span class="nav-text">优先级的退避参数设置</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">治部少辅</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.1.0</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="Total Visitors">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="Total Views">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.0"></script>

  <script src="/js/motion.js?v=7.1.0"></script>



  
  


  <script src="/js/affix.js?v=7.1.0"></script>

  <script src="/js/schemes/pisces.js?v=7.1.0"></script>



  
  <script src="/js/scrollspy.js?v=7.1.0"></script>
<script src="/js/post-details.js?v=7.1.0"></script>



  


  <script src="/js/next-boot.js?v=7.1.0"></script>


  

  

  

  
  
  <script id="dsq-count-scr" src="https://codewoody.disqus.com/count.js" async></script>


<script>
  var disqus_config = function() {
    this.page.url = "http://www.codewoody.com/knowledge-base/academic/its/wave/ns3中的wave模块/index.html";
    this.page.identifier = "knowledge-base/academic/its/wave/ns3中的wave模块/index.html";
    this.page.title = 'ns3中的wave模块';
    };
  function loadComments() {
    var d = document, s = d.createElement('script');
    s.src = 'https://codewoody.disqus.com/embed.js';
    s.setAttribute('data-timestamp', '' + +new Date());
    (d.head || d.body).appendChild(s);
  }
  
    loadComments();
  
</script>





  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  
    
      <script type="text/x-mathjax-config">
  

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      
      equationNumbers: {
        autoNumber: 'AMS'
      },
      
    }
  });
  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') { next = next.nextSibling }
        if (next && next.nodeName.toLowerCase() === 'br') { next.parentNode.removeChild(next) }
      }
    });
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      document.getElementById(all[i].inputID + '-Frame').parentNode.className += ' has-jax';
    }
  });
</script>
<script src="//cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    
  


  

  

  

  

  

  

  

  

  
<script>
  $('.highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('Copy');
      }, 300);
    }).append(e);
  })
</script>


  

  


  <script src="https://ethantw.github.io/Han/latest/han.min.js"></script>
  
  <script>
    void function(){
      // window.hinst = Han(document.querySelector('.post-body')).setRoutine([
      //   'initCond',
      //   'renderElem',
      //   'renderJiya',
      //   'renderHanging',
      //   'renderHWS',
      //   'correctBasicBD',
      //   'substCombLigaWithPUA'
      // ]).render()
      document.getElementById("refs")
          .setAttribute("lang", "en_US");
    }()

    </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>
